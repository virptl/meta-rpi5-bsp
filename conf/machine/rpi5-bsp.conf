# -----------------------------------------------------------------------------
# Custom Raspberry Pi 5 BSP Machine
# -----------------------------------------------------------------------------

#@TYPE: Machine
#@NAME: rpi5-bsp
#@DESCRIPTION: Raspberry Pi 5 BSP focused on stable boot and debug access

# -----------------------------------------------------------------------------
# Firmware licensing (Raspberry Pi Wi-Fi / BT)
# -----------------------------------------------------------------------------
LICENSE_FLAGS_ACCEPTED += "synaptics-killswitch"

# -----------------------------------------------------------------------------
# Base machine
# -----------------------------------------------------------------------------
require conf/machine/raspberrypi5.conf

# -----------------------------------------------------------------------------
# Machine overrides (CRITICAL)
# -----------------------------------------------------------------------------
# raspberrypi5 MUST come first for linux-raspberrypi BSP resolution
MACHINEOVERRIDES =. "raspberrypi5:"
MACHINEOVERRIDES .= ":rpi5-bsp"

# -----------------------------------------------------------------------------
# Console
# -----------------------------------------------------------------------------
ENABLE_UART = "1"
SERIAL_CONSOLES = "115200;ttyAMA0"
APPEND += "console=ttyAMA0,115200 console=tty1"
APPEND += "earlycon=pl011,mmio32,0x107c0000"

# -----------------------------------------------------------------------------
# Image types
# -----------------------------------------------------------------------------
IMAGE_FSTYPES += "wic wic.bmap"

# -----------------------------------------------------------------------------
# Kernel
# -----------------------------------------------------------------------------
PREFERRED_PROVIDER_virtual/kernel = "linux-raspberrypi"

# -----------------------------------------------------------------------------
# Wi-Fi
# -----------------------------------------------------------------------------
ENABLE_WIFI = "1"
MACHINE_EXTRA_RRECOMMENDS += "linux-firmware-rpidistro-bcm43456"
MACHINE_FEATURES:append = " wifi bluetooth"
